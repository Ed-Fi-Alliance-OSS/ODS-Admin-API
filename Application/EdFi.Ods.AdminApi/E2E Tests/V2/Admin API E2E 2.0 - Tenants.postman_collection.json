{
  "info": {
    "_postman_id": "a90cb420-5604-487d-8b9b-4e068d7d5314",
    "name": "Admin API E2E 2.0 - Tenants",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "47236632"
  },
  "item": [
    {
      "name": "V2",
      "item": [
        {
          "name": "Tenants",
          "item": [
            {
              "name": "Tenant without 's'",
              "event": [
                {
                  "listen": "test",
                  "script": {
                    "exec": [
                      "pm.test(\"GET Tenants: Status code is Invalid\", function () {",
                      "    pm.response.to.have.status(404);",
                      "});",
                      ""
                    ],
                    "type": "text/javascript",
                    "packages": {}
                  }
                }
              ],
              "request": {
                "method": "GET",
                "header": [],
                "url": {
                  "raw": "{{API_URL}}/v2/tenant",
                  "host": [
                    "{{API_URL}}"
                  ],
                  "path": [
                    "v2",
                    "tenant"
                  ]
                }
              },
              "response": []
            },
            {
              "name": "Tenants EdOrgs by Tenant Name - Multitenant",
              "event": [
                {
                  "listen": "test",
                  "script": {
                    "exec": [
                      "if (pm.variables.get(\"isMultitenant\") == \"true\") {",
                      "    pm.test(\"GET Tenants EdOrgs: Status code is Found\", function () {",
                      "        pm.response.to.have.status(200);",
                      "    });",
                      "",
                      "    const result = pm.response.json();",
                      "",
                      "    pm.test(\"GET Tenants EdOrgs: Response result matches tenant\", function () {",
                      "        var tenantName = pm.environment.get(\"tenant1\");",
                      "        ",
                      "        pm.expect(result.id).to.not.be.empty;",
                      "        pm.expect(result.name).to.not.be.empty;",
                      "        pm.expect(result.id.toLowerCase()).to.equal(tenantName.toLowerCase());",
                      "        pm.expect(result.name.toLowerCase()).to.equal(tenantName.toLowerCase());",
                      "        pm.expect(result.odsInstances).to.be.an('array');",
                      "        pm.expect(result.odsInstances).to.not.be.empty;",
                      "    });",
                      "",
                      "    const GetTenantEdOrgsByNameSchema = {",
                      "        \"type\": \"object\",",
                      "        \"properties\": {",
                      "            \"id\": {",
                      "                \"type\": \"string\"",
                      "            },",
                      "            \"name\": {",
                      "                \"type\": \"string\"",
                      "            },",
                      "            \"odsInstances\": {",
                      "                \"type\": \"array\",",
                      "                \"properties\": {",
                      "                    \"id\": {",
                      "                        \"type\": \"number\"",
                      "                    },",
                      "                    \"name\": {",
                      "                        \"type\": \"string\"",
                      "                    },",
                      "                    \"instanceType\": {",
                      "                        \"type\": \"string\"",
                      "                    },",
                      "                    \"educationOrganizations\": {",
                      "                        \"type\": \"array\",",
                      "                        \"properties\": {",
                      "                            \"instanceId\": {",
                      "                                \"type\": \"number\"",
                      "                            },",
                      "                            \"instanceName\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"educationOrganizationId\": {",
                      "                                \"type\": \"number\"",
                      "                            },",
                      "                            \"nameOfInstitution\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"shortNameOfInstitution\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"discriminator\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"parentId\": {",
                      "                                \"type\": \"number\"",
                      "                            }",
                      "                        },",
                      "                    }",
                      "                },",
                      "            }",
                      "        },",
                      "        \"required\": [",
                      "            \"name\"",
                      "        ]",
                      "    };",
                      "",
                      "    pm.test(\"GET Tenants EdOrgs: Validation Schema Response\", () => {",
                      "        pm.response.to.have.jsonSchema(GetTenantEdOrgsByNameSchema);",
                      "    });",
                      " ",
                      "    const header = {",
                      "        \"Content-Type\": \"application/json\",",
                      "        \"Authorization\": `Bearer ${pm.collectionVariables.get(\"TOKEN\")}`,",
                      "        \"Tenant\": `${pm.variables.get(\"tenant1\")}`",
                      "    };",
                      "",
                      "    // DELETE dependencies",
                      "    pm.sendRequest({",
                      "        url: `${pm.variables.get(\"API_URL\")}/v2/odsInstances/${pm.collectionVariables.get(\"ODSInstanceId\")}`,",
                      "        method: 'DELETE',",
                      "        header: header",
                      "    },  ",
                      "    function (err) {",
                      "        if(err) { console.log(\"Error in Pre-request:\", err); }",
                      "        else{ pm.collectionVariables.unset(\"ODSInstanceId\"); }",
                      "    });",
                      "",
                      "}",
                      "else {",
                      "    pm.test(\"GET Tenants EdOrgs: Status code is Found\", function () {",
                      "        pm.response.to.have.status(404);",
                      "    });",
                      "}"
                    ],
                    "type": "text/javascript",
                    "packages": {},
                    "requests": {}
                  }
                },
                {
                  "listen": "prerequest",
                  "script": {
                    "exec": [
                      "if (pm.variables.get(\"isMultitenant\") == \"true\") {\r",
                      "    let header = {\r",
                      "        \"Content-Type\": \"application/json\",\r",
                      "        \"Authorization\": `Bearer ${pm.collectionVariables.get(\"TOKEN\")}`,\r",
                      "        \"Tenant\": `${pm.variables.get(\"tenant1\")}`\r",
                      "    };\r",
                      "\r",
                      "    pm.collectionVariables.set(\"OdsInstanceGUID\", pm.variables.replaceIn('{{$guid}}'));\r",
                      "\r",
                      "    pm.sendRequest({\r",
                      "    url: `${pm.variables.get(\"API_URL\")}/v2/odsInstances`,\r",
                      "    method: 'POST',\r",
                      "    header: header,\r",
                      "    body: {\r",
                      "        mode: 'raw',\r",
                      "        raw:JSON.stringify({\r",
                      "            \"name\": `Test-OdsInstance-${pm.collectionVariables.get(\"OdsInstanceGUID\")}`,\r",
                      "            \"instanceType\": \"OdsInstance\",\r",
                      "            \"connectionString\": pm.environment.get(\"connectionString\"),\r",
                      "        }), \r",
                      "    }\r",
                      "    },  \r",
                      "    function (err, response) {\r",
                      "    if(err) { console.log(\"Error in Pre-request:\", err); }\r",
                      "    const id = response.headers.get(\"Location\").split(\"/\")[2];\r",
                      "    if(id)\r",
                      "        {\r",
                      "            pm.collectionVariables.set(\"ODSInstanceId\", id);\r",
                      "        }\r",
                      "    });\r",
                      "}\r",
                      "\r",
                      "\r",
                      ""
                    ],
                    "type": "text/javascript",
                    "packages": {},
                    "requests": {}
                  }
                }
              ],
              "request": {
                "method": "GET",
                "header": [],
                "url": {
                  "raw": "{{API_URL}}/v2/tenants/tenant1/edOrgsByInstances",
                  "host": [
                    "{{API_URL}}"
                  ],
                  "path": [
                    "v2",
                    "tenants",
                    "tenant1",
                    "edOrgsByInstances"
                  ]
                }
              },
              "response": []
            },
            {
              "name": "Tenants EdOrgs by Tenant Name - Singletenant",
              "event": [
                {
                  "listen": "test",
                  "script": {
                    "exec": [
                      "if (pm.variables.get(\"isMultitenant\") == \"false\") {",
                      "    pm.test(\"GET Tenants EdOrgs: Status code is Found\", function () {",
                      "        pm.response.to.have.status(200);",
                      "    });",
                      "",
                      "    const result = pm.response.json();",
                      "",
                      "    pm.test(\"GET Tenant EdOrgs: Response result matches tenant\", function () {",
                      "        pm.expect(result.id.toLowerCase()).to.equal(\"default\");",
                      "        pm.expect(result.name.toLowerCase()).to.equal(\"default\");",
                      "        pm.expect(result.odsInstances).to.be.an('array');",
                      "        pm.expect(result.odsInstances).to.not.be.empty;",
                      "    });",
                      "",
                      "    const GetTenantEdOrgsByNameSchema = {",
                      "        \"type\": \"object\",",
                      "        \"properties\": {",
                      "            \"id\": {",
                      "                \"type\": \"string\"",
                      "            },",
                      "            \"name\": {",
                      "                \"type\": \"string\"",
                      "            },",
                      "            \"odsInstances\": {",
                      "                \"type\": \"array\",",
                      "                \"properties\": {",
                      "                    \"id\": {",
                      "                        \"type\": \"number\"",
                      "                    },",
                      "                    \"name\": {",
                      "                        \"type\": \"string\"",
                      "                    },",
                      "                    \"instanceType\": {",
                      "                        \"type\": \"string\"",
                      "                    },",
                      "                    \"educationOrganizations\": {",
                      "                        \"type\": \"array\",",
                      "                        \"properties\": {",
                      "                            \"instanceId\": {",
                      "                                \"type\": \"number\"",
                      "                            },",
                      "                            \"instanceName\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"educationOrganizationId\": {",
                      "                                \"type\": \"number\"",
                      "                            },",
                      "                            \"nameOfInstitution\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"shortNameOfInstitution\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"discriminator\": {",
                      "                                \"type\": \"string\"",
                      "                            },",
                      "                            \"parentId\": {",
                      "                                \"type\": \"number\"",
                      "                            }",
                      "                        },",
                      "                    }",
                      "                },",
                      "            }",
                      "        }",
                      "    };",
                      "",
                      "    pm.test(\"GET Tenants EdOrgs: Validation Schema Response\", () => {",
                      "        pm.response.to.have.jsonSchema(GetTenantEdOrgsByNameSchema);",
                      "    });",
                      "",
                      "    const header = {",
                      "        \"Content-Type\": \"application/json\",",
                      "        \"Authorization\": `Bearer ${pm.collectionVariables.get(\"TOKEN\")}`",
                      "    };",
                      "",
                      "    // DELETE dependencies",
                      "    pm.sendRequest({",
                      "        url: `${pm.variables.get(\"API_URL\")}/v2/odsInstances/${pm.collectionVariables.get(\"ODSInstanceId\")}`,",
                      "        method: 'DELETE',",
                      "        header: header",
                      "    },  ",
                      "    function (err) {",
                      "        if(err) { console.log(\"Error in Pre-request:\", err); }",
                      "        else{ pm.collectionVariables.unset(\"ODSInstanceId\"); }",
                      "    });",
                      "}"
                    ],
                    "type": "text/javascript",
                    "packages": {},
                    "requests": {}
                  }
                },
                {
                  "listen": "prerequest",
                  "script": {
                    "exec": [
                      "if (pm.variables.get(\"isMultitenant\") == \"false\") {\r",
                      "    let header = {\r",
                      "        \"Content-Type\": \"application/json\",\r",
                      "        \"Authorization\": `Bearer ${pm.collectionVariables.get(\"TOKEN\")}`\r",
                      "    };\r",
                      "\r",
                      "    pm.collectionVariables.set(\"OdsInstanceGUID\", pm.variables.replaceIn('{{$guid}}'));\r",
                      "\r",
                      "    pm.sendRequest({\r",
                      "    url: `${pm.variables.get(\"API_URL\")}/v2/odsInstances`,\r",
                      "    method: 'POST',\r",
                      "    header: header,\r",
                      "    body: {\r",
                      "        mode: 'raw',\r",
                      "        raw:JSON.stringify({\r",
                      "            \"name\": `Test-OdsInstance-${pm.collectionVariables.get(\"OdsInstanceGUID\")}`,\r",
                      "            \"instanceType\": \"OdsInstance\",\r",
                      "            \"connectionString\": pm.environment.get(\"connectionString\"),\r",
                      "        }), \r",
                      "    }\r",
                      "    },  \r",
                      "    function (err, response) {\r",
                      "    if(err) { console.log(\"Error in Pre-request:\", err); }\r",
                      "    const id = response.headers.get(\"Location\").split(\"/\")[2];\r",
                      "    if(id)\r",
                      "        {\r",
                      "            pm.collectionVariables.set(\"ODSInstanceId\", id);\r",
                      "        }\r",
                      "    });\r",
                      "}"
                    ],
                    "type": "text/javascript",
                    "packages": {},
                    "requests": {}
                  }
                }
              ],
              "request": {
                "method": "GET",
                "header": [],
                "url": {
                  "raw": "{{API_URL}}/v2/tenants/default/edOrgsByInstances",
                  "host": [
                    "{{API_URL}}"
                  ],
                  "path": [
                    "v2",
                    "tenants",
                    "default",
                    "edOrgsByInstances"
                  ]
                }
              },
              "response": []
            }
          ]
        }
      ]
    }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{TOKEN}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "exec": [
          "function generateClientSecret() {",
          "    const minLength = 32;",
          "    const maxLength = 128;",
          "    let result = '';",
          "    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';",
          "    const specialCharacters = '!@#$%^&*()_+{}:\"<>?|[];\\',./`~';",
          "    const length = Math.floor(Math.random() * (maxLength - minLength + 1)) + minLength;",
          "",
          "    result += randomChar('abcdefghijklmnopqrstuvwxyz');",
          "    result += randomChar('ABCDEFGHIJKLMNOPQRSTUVWXYZ');",
          "    result += randomChar('0123456789');",
          "    result += randomChar(specialCharacters);",
          "",
          "    for (let i = result.length; i < length; i++) {",
          "        const charactersPlusSpecial = characters + specialCharacters;",
          "        result += charactersPlusSpecial.charAt(Math.floor(Math.random() * charactersPlusSpecial.length));",
          "    }",
          "",
          "    return shuffleString(result);",
          "}",
          "",
          "function randomChar(str) {",
          "    return str.charAt(Math.floor(Math.random() * str.length));",
          "}",
          "",
          "function shuffleString(str) {",
          "    const array = str.split('');",
          "    for (let i = array.length - 1; i > 0; i--) {",
          "        const j = Math.floor(Math.random() * (i + 1));",
          "        [array[i], array[j]] = [array[j], array[i]];",
          "    }",
          "    return array.join('');",
          "}",
          "",
          "let guid = pm.variables.replaceIn('{{$guid}}');",
          "let client_secret =  generateClientSecret();",
          "",
          "let header = {",
          "    'Content-Type': 'application/x-www-form-urlencoded'",
          "};",
          "",
          "if (pm.variables.get(\"isMultitenant\") == \"true\") {",
          "    header['Tenant'] = `${pm.variables.get(\"tenant1\")}`;",
          "    pm.request.headers.upsert({key: 'Tenant', value: `${pm.variables.get(\"tenant1\")}` });",
          "}",
          "",
          "pm.sendRequest({",
          "    url: `${pm.variables.get(\"API_URL\")}/connect/register`,",
          "    method: 'POST',",
          "    header: header,",
          "    body: {",
          "        mode: 'urlencoded',",
          "        urlencoded: [",
          "            {key: 'ClientId', value: guid },",
          "            {key: 'ClientSecret', value: client_secret },",
          "            {key: 'DisplayName', value: guid }",
          "        ]",
          "    }",
          "},",
          "    (err, res) => {",
          "        error = res.json().error",
          "        if(error) {",
          "            throw res.json().error_description",
          "        }",
          "",
          "pm.sendRequest({",
          "    url: `${pm.variables.get(\"API_URL\")}/connect/token`,",
          "    method: 'POST',",
          "    header: header,",
          "    body: {",
          "        mode: 'urlencoded',",
          "        urlencoded: [",
          "            {key: 'client_id', value: guid },",
          "            {key: 'client_secret', value: client_secret },",
          "            {key: 'grant_type', value: \"client_credentials\"},",
          "            {key: 'scope', value: \"edfi_admin_api/full_access\"}",
          "        ]",
          "    }",
          "},",
          "    (err, res) => {",
          "        error = res.json().error",
          "        if(error) {",
          "            throw res.json().error_description",
          "        }",
          "        pm.collectionVariables.set(\"TOKEN\", res.json().access_token)",
          "});",
          "});"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "packages": {},
        "exec": [
          ""
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "TOKEN",
      "value": ""
    },
    {
      "key": "OdsInstanceGUID",
      "value": ""
    }
  ]
}