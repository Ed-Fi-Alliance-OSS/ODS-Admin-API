meta {
  name: Tenants EdOrgs by Tenant Name - Singletenant
  type: http
  seq: 8
}

get {
  url: {{API_URL}}/v2/tenants/default/OdsInstances/edOrgs
  body: none
  auth: inherit
}

script:pre-request {
  // Safely set Node.js environment variable if available (CLI only)
  try {
    if (typeof process !== 'undefined' && process.env) {
      process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    }
  } catch (e) {
    // Ignore in UI environment
  }
  
  // Add tenant header if multitenant mode is enabled
  if (bru.getEnvVar("isMultitenant") == "false") {
    console.log("ðŸ”§ Setting pre environment to ignore SSL certificates...");
  
    const axios = require('axios');
    const API_URL = bru.getEnvVar("API_URL");
    const TOKEN = bru.getEnvVar("TOKEN");
    const timestamp = Date.now();
    
    // Configure axios to handle SSL and network issues
    const axiosConfig = {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${TOKEN}`,
      },
      validateStatus: function (status) {
        return status < 500;
      },
      timeout: 30000
    };
    
    try {
      const objectName = "OdsInstance";
      const response = await axios.post(`${API_URL}/v2/odsInstances`, {
        "name": `OdsInstance-E2E-${timestamp}`,
        "instanceType": "OdsInstance",
        "connectionString": `${bru.getEnvVar("connectionString")}`
      }, axiosConfig);
  
      if (response.status === 201 && response.headers.location) {
        const id = response.headers.location.split("/")[2];
        bru.setVar("created-odsInstanceId", id);
        console.log(`âœ… ${objectName} created successfully with ID:`, id);
      } else {
        console.log(`âŒ Failed to create ${objectName}:`);
        console.log("Status:", response.status);
        console.log("Response headers:", JSON.stringify(response.headers));
        console.log("Response data:", JSON.stringify(response.data, null, 2));
        
        throw new Error(`Failed to create ${objectName} - Status: ${response.status}, Data: ${JSON.stringify(response.data)}`);
      }
    } catch (error) {
      console.log("Error in pre-request setup:", error.message);
    }
  }
  
  
}

script:post-response {
  if (bru.getEnvVar("isMultitenant") == "false") {
  
    test("GET Tenants OdsInstances EdOrgs: Status code is Found", function () {
        expect(res.getStatus()).to.equal(200);
    });
  
    const response = res.getBody();
    const Ajv = require('ajv');
    const ajv = new Ajv();
    const GetTenantOdsInstancesEdOrgsSchema = {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "odsInstances": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": {
                "type": "integer"
              },
              "name": {
                "type": "string"
              },
              "instanceType": {
                "type": ["string", "null"]
              },
              "educationOrganizations": {
                "type": "array",
                "items": {
                  "type": "object",
                  "properties": {
                    "educationOrganizationId": {
                      "type": "integer"
                    },
                    "nameOfInstitution": {
                      "type": "string"
                    },
                    "shortNameOfInstitution": {
                      "type": ["string", "null"]
                    },
                    "discriminator": {
                      "type": "string"
                    },
                    "parentId": {
                      "type": ["integer", "null"]
                    }
                  },
                  "required": ["educationOrganizationId", "nameOfInstitution", "discriminator"]
                }
              }
            },
            "required": ["id", "name", "educationOrganizations"]
          }
        }
      },
      "required": ["id", "name", "odsInstances"]
    };
  
    test("GET Tenants OdsInstances EdOrgs: Response matches schema", function () {
        expect(ajv.validate(GetTenantOdsInstancesEdOrgsSchema, response)).to.equal(true);
    });
  
  
    // DELETE dependencies
    // Safely set Node.js environment variable if available (CLI only)
    try {
      if (typeof process !== 'undefined' && process.env) {
        process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
      }
    } catch (e) {
      // Ignore in UI environment
    }
     
    const axios = require('axios');
    const API_URL = bru.getEnvVar("API_URL");
    const TOKEN = bru.getEnvVar("TOKEN");
    
    // Configure axios to handle SSL and network issues
    const axiosConfig = {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${TOKEN}`,
      },
      validateStatus: function (status) {
        return status < 500;
      },
      timeout: 30000
    };
    
    try {
      const objectName = "OdsInstance";
      const response = await axios.delete(`${API_URL}/v2/odsInstances/${bru.getVar("created-odsInstanceId")}`, axiosConfig);
  
      if (response.status === 200) {
        console.log(`âœ… ${objectName} with ID ${bru.getVar("created-odsInstanceId")} removed successfully`);
        bru.deleteVar("created-odsInstanceId");
      } else {
        console.log(`âŒ Failed to delete ${objectName}:`);
        console.log("Status:", response.status);
        console.log("Response headers:", JSON.stringify(response.headers));
        console.log("Response data:", JSON.stringify(response.data, null, 2));
        throw new Error(`Failed to delete ${objectName} - Status: ${response.status}, Data: ${JSON.stringify(response.data)}`);
      }
    } catch (error) {
      console.log("Error in post-request clean up:", error.message);
    }
  
  
  }
  else {
      test("GET Tenants OdsInstances EdOrgs: Status code is Found", function () {
          expect(res.getStatus()).to.equal(400);
      });
  }
}
