meta {
  name: Landing Page
  type: http
  seq: 1
}

get {
  url: {{API_URL}}
  body: json
  auth: none
}

script:post-response {
  test("GET Landing: Status code is OK", function () {
      expect(res.getStatus()).to.equal(200);
  });
  
  const response = res.getBody();
  
  test("GET Landing: Response includes expected properties", function () {
      expect(response).to.have.property("version");
      expect(response).to.have.property("build");
      expect(response).to.have.property("tenancy");
  });
  
  test("GET Landing: Response tenancy includes expected properties", function () {
      expect(response.tenancy).to.have.property("multitenantMode");
      expect(response.tenancy).to.have.property("tenants");
      expect(response.tenancy.multitenantMode).to.be.a("boolean");
      expect(response.tenancy.tenants).to.be.an("array");
  });
  
  const Ajv = require('ajv');
  const ajv = new Ajv();
  const GetSchemaLanding =  {
    "type": "object",
    "properties": {
      "tenancy": {
        "type": "object",
        "properties": {
          "multitenantMode": {
            "type": "boolean"
          },
          "tenants": {
            "type": "array",
            "items": {
              "type": "string"
            }
          }
        },
        "required": [
          "multitenantMode",
          "tenants"
        ]
      },
      "version": {
        "type": "string"
      },
      "build": {
        "type": "string"
      }
    },
    "required": [
      "tenancy",
      "version",
      "build"
    ]
  }
  
  test("GET Landing: Validation Schema Response", () => {
      const valid = ajv.validate(GetSchemaLanding, response);
      expect(valid).to.be.true;
      
      if (!valid) {
          console.log("Schema validation errors:", ajv.errors);
      }
  });
  
  if (bru.getEnvVar("isMultitenant") == "true") {
    test("GET Landing: Multitenant mode - multitenantMode is true", function () {
        expect(response.tenancy.multitenantMode).to.be.true;
    });
  
    test("GET Landing: Multitenant mode - tenants list is not empty", function () {
        expect(response.tenancy.tenants.length).to.be.greaterThan(0);
    });
  
    test("GET Landing: Multitenant mode - tenants list contains configured tenants", function () {
        const tenant1 = bru.getEnvVar("tenant1");
        const tenant2 = bru.getEnvVar("tenant2");
        if (tenant1) expect(response.tenancy.tenants).to.include(tenant1);
        if (tenant2) expect(response.tenancy.tenants).to.include(tenant2);
    });
  } else {
    test("GET Landing: Singletenant mode - multitenantMode is false", function () {
        expect(response.tenancy.multitenantMode).to.be.false;
    });
  
    test("GET Landing: Singletenant mode - tenants list is empty", function () {
        expect(response.tenancy.tenants).to.have.length(0);
    });
  }
  
}

settings {
  encodeUrl: true
}
